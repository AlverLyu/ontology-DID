<h1 align="center">End-to-End（End-to-End）Data Encryption Standard </h1>

In a decentralized data collaboration scenario, the data provider (Provider) needs to securely pass the data to the requestor, ie the data is only visible to the Requester and not to any other third party, that is, the ciphertext state; even if other people obtain the ciphertext, it still cannot be decrypted.

Both parties to the data transaction have an ONT ID, so we combine the ONT ID with the common hybrid encryption mechanism of public key cryptography to design a data encryption and decryption algorithm.

## Explanation of Terms

This section briefly introduces terms related to data encryption decryption algorithms.

- Public key encryption algortithm（public key encryption algorithm）
- Symmetric encryption algorithm（symmetric encryption algorithm）
- Public key（public key）
- Private key（private key）
- Secret key（secret key）

## Data Encryption

In general, the data encryption algorithm uses the well-known "hybrid encryption" mode <sup>[1]</sup>, that is, uses the public key encryption algorithm (PKE) to encrypt the symmetric algorithm key (secret key) to obtain the encryptedKey, and then uses the key from symmetric encryption algorithm to encrypt data, and get the ciphertext. The specific process consists of three steps:

1. Get public key：Visit Ontology blockchain，get the buyer's public key list, and randomly choose a public key from the list；
2. Random sampling AES secret key：Random sampling 256 bit data，as AES block secret key;
3. Hybrid encryption： Encrypt the 256-bit AES key with the public key encryption algorithm to obtain the encryptedKey，
Data is encrypted using the AES algorithm GCM mode 
ciphertext = AES-256-GCM(secret, IV, AAD, data)。

The encrypted ciphertext of the data consists of three parts：public key information、 encryptedKey, and ciphertext，using JSON
format to save ciphertext metainformation，the format of which is defined in Table 1，and the sample code refers to`Code Sample 1`。The authentication data(AAD) in the AES-GCM mode is OntID || PkIndex。(`||`Indicates byte stitching)

```json
{
    "OntID": "did:ont:AZk5wBNiV8dCPAFXoGvDSvetfufuXJXM8r",
    "PkIndex": 1,
    "IV": "63E8B8136C101AEF06E25FF3",
    "EncryptedKey": "...",
    "CiphertextURL": "https://example.com/ciphertext.dat",
    "AuthTag": "..."
}
```
_Sample code 1. Ciphertext metadata.json_

|Field Name|Field Size|Note|
|---|---|---|
|OntID|indefinite|Receient's OntID|
|PkIndex|4 Bytes|Recipient public key index（4 Bytes）|
|IV|12 Bytes|used for initial vector in AES-256-GCM mode|
|EncryptedKey|indefinite|AES key encrypted by public key|
|Ciphertext|indefinite|用The URL of the encrypted data by the symmetric encryption algorithm|
|AuthTag|indefinite|Certification label，that is, MAC|

_Table 1.1 Ciphertext metadata JSON Object Field Definition_

The input and output of the algorithm are listed in Table 2, respectively.

| Input | Output |
| ---  | --- |
| I. recepient's OntID | ciphertext JSON object | 
| II. public key index PkIndex || 
| III. public key pk || 
| IV. data to be encrypted data || 
| V. authentication data AAD || 

_Table 1.2 input and output of Data encryption algorithm_

Below we describe the encryption algorithm flow in detail.

1. Random Sampling 12 byte data，called `IV`；
2. Random Sampling 32 byte data，called `secret key`；
3. Use publick key `pk` to encrypt `secret key`，getting `encryptedKey`；According to the public key type, select the corresponding public key encryption algorithm, such as an elliptic curve type public key, and choose to use the `ECIES` algorithm <sup>[3]</sup>;
4. Use `secret key` as `AES-256-GCM` mode<sup>[2]</sup> Encryption algorithm key， `IV` as initial vector， `AAD` as authentication data, encrypt `data` to get `ciphertext` and athentication tag`AuthTag`；
5. Construct ciphertext JSON object and return it.

<img src="../../images/9533c7fb5937dcaf7e0348dd8dfb7a6.png">

_Graph 1.3 Data Encryption Algorithm Schematic_

## Data decryption

The decryption of the data is performed in the following three steps:
1. According to `Ont ID` and `PkIndex`，Find the corresponding private key from the private key management module；
2. Use private key to decrypt `encryptedKey` and get AES symmetric key `secret key`；
3. Use AES symmetric key `secret key`，and AES-256 algorithm GCM mode to decrypt data.

Below we describe the decryption algorithm flow in detail.

1. Solve `IV`, `AAD`, `ciphertext`from JSON object ；
2. JSON 对象Solve `encryptedKey` from ciphertext；
3. Use private key `sk` decrypt `encryptedKey` to get `secret key`；Select the corresponding public key decryption algorithm according to the public key type. Note that `sk` is the private key for the decrypting user, and `secret key` is the `AES` key randomly generated by the user in the encryption step.；
4. Use `secret key` as the key of `AES-256-GCM` mode<sup>[2]</sup> decryption algorithm， `IV` as initial vector， `AAD` as authentication data，to decrypt `ciphertext`. If failing，return “failure”. Or, return decryted data.


## References

1. Wikipedia, Hybrid cryptosystem.
https://en.wikipedia.org/wiki/Hybrid_cryptosystem.
2. McGrew D, Viega J. The Galois/counter mode of operation (GCM).
Submission to NIST Modes of Operation Process. 2004 Jan 15;20.
3. Gayoso Martínez, V., Hernández Encinas, L., & Sánchez Ávila, C. (2010). A
survey of the elliptic curve integrated encryption scheme.